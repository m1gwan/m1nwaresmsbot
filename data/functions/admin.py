from aiogram import types
import sqlite3, datetime, time

from data import functions as func


def get_users():
    conn, cursor = func.connect()

    users = cursor.execute(f'SELECT * FROM users').fetchall()

    return users

def admin_stats():
    conn, cursor = func.connect()

    cursor.execute(f'SELECT * FROM users')
    row = cursor.fetchall()

    day = datetime.timedelta(days=1)
    hour = datetime.timedelta(hours=1)
    date = datetime.datetime.now()

    amount_user_all = 0
    amount_user_day = 0
    amount_user_hour = 0

    for i in row:
        amount_user_all += 1

        if date - datetime.datetime.fromisoformat(i[6]) <= day:
            amount_user_day += 1
        if date - datetime.datetime.fromisoformat(i[6]) <= hour:
            amount_user_hour += 1

    cursor.execute(f'SELECT * FROM deposit_logs')
    pay = cursor.fetchall()

    qiwi = 0
    all_qiwi = 0
    banker = 0
    all_banker = 0
    chatex = 0
    all_chatex = 0

    for i in pay:
        if i[2] == 'qiwi':
            if date - datetime.datetime.fromisoformat(i[4]) <= day:
                qiwi += float(i[3])

            all_qiwi += float(i[3])

        elif i[2] == 'banker':
            if date - datetime.datetime.fromisoformat(i[4]) <= day:
                banker += float(i[3])

            all_banker += float(i[3])
        elif i[2] == 'chatex':
            if date - datetime.datetime.fromisoformat(i[4]) <= day:
                chatex += float(i[3])

            all_chatex += float(i[3])


    msg = f"""
<b>üíà –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö:</b>

‚ùï –ó–∞ –≤—Å–µ –≤—Ä–µ–º—è: <b>{amount_user_all}</b>
‚ùï –ó–∞ –¥–µ–Ω—å: <b>{amount_user_day}</b>
‚ùï –ó–∞ —á–∞—Å: <b>{amount_user_hour}</b>

<b>üíà –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π –∑–∞ 24 —á–∞—Å–∞</b>
‚ùï QIWI: <b>{qiwi} ‚ÇΩ</b>
‚ùï Banker: <b>{banker} ‚ÇΩ</b>
‚ùï Chatex: <b>{chatex} ‚ÇΩ</b>

<b>üíà –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è</b>
üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è QIWI: <b>{all_qiwi} ‚ÇΩ</b>
üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è BANKER: <b>{all_banker} ‚ÇΩ</b>
üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è Chatex: <b>{all_chatex} ‚ÇΩ</b>
{func.System().info_msg()}
"""

    return msg

def admin_marg():
    conn, cursor = func.connect()

    cursor.execute('SELECT * FROM service_logs')
    row = cursor.fetchall()

    spending_all = 0
    spending_90d = 0
    spending_month = 0
    spending_7d = 0
    spending_day = 0
    spending_hour = 0

    profit_all = 0
    profit_90d = 0
    profit_month = 0
    profit_7d = 0
    profit_day = 0
    profit_hour = 0

    good_act = 0
    good_act_90d = 0
    good_act_month = 0
    good_act_7d = 0
    good_act_day = 0

    for i in row:
        if i[7] == 'good' or i[7] == 'more_good':
            spending_all += float(i[5])
            profit_all += float(i[5]) - float(i[6])
            good_act += 1

            if time.time() - float(i[8]) <= 7776000:
                spending_90d += float(i[5])
                profit_90d += float(i[5]) - float(i[6])
                good_act_90d += 1

            if time.time() - float(i[8]) <= 2592000:
                spending_month += float(i[5])
                profit_month += float(i[5]) - float(i[6])
                good_act_month += 1

            if time.time() - float(i[8]) <= 604800:
                spending_7d += float(i[5])
                profit_7d += float(i[5]) - float(i[6])
                good_act_7d += 1

            if time.time() - float(i[8]) <= 86400:
                spending_day += float(i[5])
                profit_day += float(i[5]) - float(i[6])
                good_act_day += 1

            if time.time() - float(i[8])  <= 3600:
                spending_hour += float(i[5])
                profit_hour += float(i[5]) - float(i[6])

    cursor.execute('SELECT * FROM logs_rent')
    row = cursor.fetchall()

    day = datetime.timedelta(days=1)
    day7 = datetime.timedelta(days=7)
    month = datetime.timedelta(weeks=1)
    day90 = datetime.timedelta(weeks=3)
    hour = datetime.timedelta(hours=1)
    date = datetime.datetime.now()

    good_rent = 0
    good_rent_90d = 0
    good_rent_month = 0
    good_rent_7d = 0
    good_rent_day = 0

    for i in row:
        spending_all += float(i[3])
        profit_all += float(i[3]) - float(i[4])
        good_rent += 1

        if date - datetime.datetime.fromisoformat(i[5]) <= day90:
            spending_90d += float(i[3])
            profit_90d += float(i[3]) - float(i[4])
            good_rent_90d += 1
        
        if date - datetime.datetime.fromisoformat(i[5]) <= month:
            spending_month += float(i[3])
            profit_month += float(i[3]) - float(i[4])
            good_rent_month += 1

        if date - datetime.datetime.fromisoformat(i[5]) <= day7:
            spending_7d += float(i[3])
            profit_7d += float(i[3]) - float(i[4])
            good_rent_7d += 1

        if date - datetime.datetime.fromisoformat(i[5]) <= day:
            spending_day += float(i[3])
            profit_day += float(i[3]) - float(i[4])
            good_rent_day += 1

        if date - datetime.datetime.fromisoformat(i[5]) <= hour:
            spending_hour += float(i[3])
            profit_hour += float(i[3]) - float(i[4])

    msg = f"""
üö∏–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è: {round(spending_all)} ‚ÇΩ
„ÄΩÔ∏è –ú–∞—Ä–∂–∞ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è: {round(profit_all)} ‚ÇΩ

üö∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –∑–∞ 90 –¥–Ω–µ–π: {round(spending_90d)} ‚ÇΩ
„ÄΩÔ∏è –ú–∞—Ä–∂–∞ –∑–∞ 90 –¥–Ω–µ–π: {round(profit_90d)} ‚ÇΩ

üö∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –∑–∞ 30 –¥–Ω–µ–π: {round(spending_month)} ‚ÇΩ
„ÄΩÔ∏è –ú–∞—Ä–∂–∞ –∑–∞ 30 –¥–Ω–µ–π: {round(profit_month)} ‚ÇΩ

üö∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –∑–∞ 7 –¥–Ω–µ–π: {spending_7d} ‚ÇΩ
„ÄΩÔ∏è –ú–∞—Ä–∂–∞ –∑–∞ 7 –¥–Ω–µ–π: {round(profit_7d)} ‚ÇΩ

üö∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –∑–∞ —Å—É—Ç–∫–∏: {spending_day} ‚ÇΩ
„ÄΩÔ∏è –ú–∞—Ä–∂–∞ –∑–∞ —Å—É—Ç–∫–∏: {round(profit_day)} ‚ÇΩ

üö∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –∑–∞ —á–∞—Å: {spending_hour} ‚ÇΩ
„ÄΩÔ∏è –ú–∞—Ä–∂–∞ –∑–∞ —á–∞—Å: {round(profit_hour)} ‚ÇΩ

<b>üíà –ê–∫—Ç–∏–≤–∞—Ü–∏–∏:</b>
üåÄ –£—Å–ø–µ—à–Ω—ã—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è: <b>{good_act} —à—Ç</b>
üåÄ –£—Å–ø–µ—à–Ω—ã—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ 90 –¥–Ω–µ–π: <b>{good_act_90d} —à—Ç</b>
üåÄ –£—Å–ø–µ—à–Ω—ã—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ 30 –¥–Ω–µ–π: <b>{good_act_month} —à—Ç</b>
üåÄ –£—Å–ø–µ—à–Ω—ã—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ 7 –¥–Ω–µ–π: <b>{good_act_7d} —à—Ç</b>
üåÄ –£—Å–ø–µ—à–Ω—ã—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∑–∞ —Å—É—Ç–∫–∏: <b>{good_act_day} —à—Ç</b>

<b>üíà –î–∞–Ω–Ω—ã–µ –ø–æ –∞—Ä–µ–Ω–¥–µ:</b>
üåÄ –ê—Ä–µ–Ω–¥ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è: <b>{good_rent} —à—Ç</b>
üåÄ –ê—Ä–µ–Ω–¥ –∑–∞ 90 –¥–Ω–µ–π: <b>{good_rent_90d} —à—Ç</b>
üåÄ –ê—Ä–µ–Ω–¥ –∑–∞ 30 –¥–Ω–µ–π: <b>{good_rent_month} —à—Ç</b>
üåÄ –ê—Ä–µ–Ω–¥ –∑–∞ 7 –¥–Ω–µ–π: <b>{good_rent_7d} —à—Ç</b>
üåÄ –ê—Ä–µ–Ω–¥ –∑–∞ —Å—É—Ç–∫–∏: <b>{good_rent_day} —à—Ç</b>
    """

    return msg

def down_sending(types, text, photo, date):
    conn, cursor = func.connect()

    data = [types, text, photo, date]
    sql = 'INSERT INTO sending VALUES (?,?,?,?)'

    cursor.execute(sql, data)
    conn.commit()

def sending_check():
    conn, cursor = func.connect()
    
    cursor.execute(f'SELECT * FROM sending')
    row = cursor.fetchall()

    for i in row:
        if datetime.datetime.fromisoformat(i[3]) <= datetime.datetime.now():
            cursor.execute(f'DELETE FROM sending WHERE photo = "{i[2]}"')
            conn.commit()

            return i

    return False

def down_sending_markup():
    conn, cursor = func.connect()
    cursor.execute(f'SELECT * FROM sending')
    info = cursor.fetchall()
    if len(info) > 0:
        markup = types.InlineKeyboardMarkup(row_width=2)
        x1 = 0
        x2 = 1
        try:
            for i in range(len(info)):
                markup.add(
                    types.InlineKeyboardButton(text=f'üíà {info[x1][3]} üìù{info[x1][1]}', callback_data=f'info_sending:{info[x1][2]}'),
                    types.InlineKeyboardButton(text=f'üíà {info[x2][3]} üìù{info[x2][1]}', callback_data=f'info_sending:{info[x2][2]}')
                )

                x1 += 2
                x2 += 2
        except:
            try:
                markup.add(
                    types.InlineKeyboardButton(text=f'üíà {info[x1][3]} üìù{info[x1][1]}', callback_data=f'info_sending:{info[x1][2]}')
                )
            except:
                return markup

        return markup

    else:
        return False

def down_sending_info(code):
    conn, cursor = func.connect()
    
    cursor.execute(f'SELECT * FROM sending WHERE photo = "{code}"')
    info = cursor.fetchone()

    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add( 
        types.InlineKeyboardButton(text=f'–£–¥–∞–ª–∏—Ç—å', callback_data=f'del_sending:{code}'),
        types.InlineKeyboardButton(text=f'–í—ã–π—Ç–∏', callback_data=f'to_closed'),
    )

    msg = f"""
<b>üñ≤ –¢–∏–ø —Ä–∞—Å—Å—ã–ª–∫–∏:</b> {info[0]}
<b>üóí –¢–µ–∫—Å—Ç:</b>
{info[1]}
<b>üìÜ –î–∞—Ç–∞:</b> {info[3]}
    """

    return msg, markup

def del_sending(code):
    conn, cursor = func.connect()
    cursor.execute(f'DELETE FROM sending WHERE photo = "{code}"')
    conn.commit()


def add_button(name, info, photo):
    conn, cursor = func.connect()
    
    cursor.execute(f'INSERT INTO buttons VALUES ("{name}", "{info}", "{photo}")')
    conn.commit()

def btn_menu_list():
    conn, cursor = func.connect()

    cursor.execute(f'SELECT * FROM buttons')
    base = cursor.fetchall()
    btn_list = []
    for i in base:
        btn_list.append(i[0])

    return btn_list

def info_buttons(name):
    conn, cursor = func.connect()

    cursor.execute(f'SELECT * FROM buttons WHERE name = "{name}"')
    info = cursor.fetchone()

    return info

def buttons_markup():
    conn, cursor = func.connect()
    cursor.execute(f'SELECT * FROM buttons')
    info = cursor.fetchall()
    if len(info) > 0:
        markup = types.InlineKeyboardMarkup(row_width=2)
        x1 = 0
        x2 = 1
        try:
            for i in range(len(info)):
                markup.add(
                    types.InlineKeyboardButton(text=f'üåÄ {info[x1][0]} ', callback_data=f'info_btn:{info[x1][2]}'),
                    types.InlineKeyboardButton(text=f'üåÄ {info[x2][0]} ', callback_data=f'info_btn:{info[x2][2]}')
                )

                x1 += 2
                x2 += 2
        except:
            try:
                markup.add(
                    types.InlineKeyboardButton(text=f'üåÄ {info[x1][0]}', callback_data=f'info_btn:{info[x1][2]}')
                )
            except:
                return markup

        return markup

    else:
        return False

def btn_info(code):
    conn, cursor = func.connect()
    
    cursor.execute(f'SELECT * FROM buttons WHERE photo = "{code}"')
    info = cursor.fetchone()

    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add( 
        types.InlineKeyboardButton(text=f'–£–¥–∞–ª–∏—Ç—å', callback_data=f'del_btn:{code}'),
        types.InlineKeyboardButton(text=f'–í—ã–π—Ç–∏', callback_data=f'to_closed'),
    )

    msg = f"""
<b>üåÄ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏:</b> {info[0]}
<b>üóí –û–ø–∏—Å–∞–Ω–∏–µ:</b>
{info[1]}
    """

    return msg, markup

def delete_button(code):
    conn, cursor = func.connect()
    
    cursor.execute(f'DELETE FROM buttons WHERE photo = "{code}"')
    conn.commit()

def payments_user_markup(user_id):
    conn, cursor = func.connect()
    cursor.execute(f'SELECT * FROM deposit_logs WHERE user_id = "{user_id}"')
    info = cursor.fetchall()
    if len(info) > 0:
        markup = types.InlineKeyboardMarkup(row_width=2)
        x1 = 0
        x2 = 1
        try:
            for i in range(len(info)):
                markup.add(
                    types.InlineKeyboardButton(
                            text=f'üåÄ {info[x1][2]} | {info[x1][3]} RUB', callback_data=f'info_pay:{info[x1][0]}'),
                    types.InlineKeyboardButton(
                            text=f'üåÄ {info[x2][2]} | {info[x2][3]} RUB ', callback_data=f'info_pay:{info[x2][0]}')
                )

                x1 += 2
                x2 += 2
        except:
            try:
                markup.add(
                    types.InlineKeyboardButton(
                            text=f'üåÄ {info[x1][2]} | {info[x1][3]} RUB', callback_data=f'info_pay:{info[x1][0]}')
                )
            except:
                return markup

        return markup

    else:
        return False